<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–®–∞–≥–æ–º–µ—Ä Telegram Mini App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100dvh;
      margin: 0;
      background: #f5f7fa;
    }
    h1 { margin: 0 0 .5em; font-size: 1.8rem; }
    #count { font-size: 3.4rem; font-weight: 700; margin-bottom: 1.4em; }
    button {
      padding: .8em 2.2em;
      font-size: 1.1rem;
      border: none;
      border-radius: 12px;
      background: #1088f0;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled { opacity: .5; cursor: default; }
    #message {
      color: #999;
      margin-top: 1em;
      font-size: .9rem;
      text-align: center;
      max-width: 20em;
    }
  </style>
</head>
<body>
  <h1>–®–∞–≥–æ–≤ —Å–µ–≥–æ–¥–Ω—è</h1>
  <div id="count">0</div>
  <button id="toggle">–°—Ç–∞—Ä—Ç</button>
  <div id="message"></div>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω—ã –≤–Ω—É—Ç—Ä–∏ Telegram Mini App
    if (!window.Telegram?.WebApp) {
      document.body.innerHTML =
        '<p style="padding:2em;text-align:center">' +
        '–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞ –≤ –º–æ–±–∏–ª—å–Ω–æ–º Telegram.' +
        '</p>';
    } else {
      const webApp = Telegram.WebApp;
      const btn = document.getElementById('toggle');
      const out = document.getElementById('count');
      const msg = document.getElementById('message');

      // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ–¥—Å—á—ë—Ç–∞ —à–∞–≥–æ–≤
      let steps = 0;
      let g = 0;
      let lastTime = 0;
      const alpha = 0.975;      // –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏
      const THRESHOLD = 1.2;    // –ø–æ—Ä–æ–≥ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —à–∞–≥–∞ (m/s¬≤)
      const MIN_INTERVAL = 300; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —à–∞–≥–∞–º–∏, –º—Å

      // –ö–æ–≥–¥–∞ –¥–∞—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω
      webApp.onEvent('accelerometerStarted', () => {
        btn.textContent = '–°—Ç–æ–ø';
        btn.disabled = false;
        msg.textContent = '–î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ä—É–∫–µ –∏–ª–∏ –≤ –∫–∞—Ä–º–∞–Ω–µ –∏ –∏–¥–∏—Ç–µ üòä';
      });

      // –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞
      webApp.onEvent('accelerometerChanged', () => {
        const { x, y, z } = Telegram.WebApp.Accelerometer;
        const mag = Math.hypot(x, y, z);
        g = alpha * g + (1 - alpha) * mag;
        const a = mag - g;
        const now = performance.now();

        if (a > THRESHOLD && now - lastTime > MIN_INTERVAL) {
          steps++;
          lastTime = now;
          out.textContent = steps;
        }
      });

      // –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –¥–∞—Ç—á–∏–∫–∞
      webApp.onEvent('accelerometerFailed', (params) => {
        btn.textContent = '–°—Ç–∞—Ä—Ç';
        btn.disabled = false;
        msg.textContent = '–û—à–∏–±–∫–∞ –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞: ' + (params.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è');
      });

      // –î–∞—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
      webApp.onEvent('accelerometerStopped', () => {
        btn.textContent = '–°—Ç–∞—Ä—Ç';
        btn.disabled = false;
        msg.textContent = '–ü–∞—É–∑–∞';
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –°—Ç–∞—Ä—Ç/–°—Ç–æ–ø
      btn.addEventListener('click', () => {
        if (Telegram.WebApp.Accelerometer.isStarted) {
          btn.disabled = true;
          Telegram.WebApp.Accelerometer.stop();
        } else {
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º —Å—Ç–∞—Ä—Ç–µ
          steps = 0;
          out.textContent = 0;

          btn.disabled = true;
          btn.textContent = '–ó–∞–ø—Ä–æ—Å‚Ä¶';
          msg.textContent = '';
          Telegram.WebApp.Accelerometer.start({ refresh_rate: 100 });
        }
      });

      // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ UI –≥–æ—Ç–æ–≤
      webApp.ready();
    }
  </script>
</body>
</html>
