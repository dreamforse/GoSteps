<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<title>–®–∞–≥–æ–º–µ—Ä Telegram Mini App</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
*{box-sizing:border-box}body{font-family:sans-serif;display:flex;flex-direction:column;
align-items:center;justify-content:center;height:100dvh;margin:0;background:#f5f7fa}
h1{margin:0 0 .5em;font-size:1.8rem}
#count{font-size:3.4rem;font-weight:700;margin-bottom:1.4em}
button{padding:.8em 2.2em;font-size:1.1rem;border:0;border-radius:12px;
background:#1088f0;color:#fff;font-weight:600;cursor:pointer}
button:disabled{opacity:.5;cursor:default}
.msg{color:#999;margin-top:1em;font-size:.9rem;text-align:center;max-width:20em}
</style>

<h1>–®–∞–≥–æ–≤ —Å–µ–≥–æ–¥–Ω—è</h1>
<div id="count">0</div>
<button id="btn">–°—Ç–∞—Ä—Ç</button>
<div class="msg" id="msg"></div>

<!-- Telegram SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
/* ===== –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω—ã –≤–Ω—É—Ç—Ä–∏ Telegram Web App ===== */
if (!window.Telegram?.WebApp) {
  document.body.innerHTML =
    '<p style="padding:2em;text-align:center">–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞ –≤ –º–æ–±–∏–ª—å–Ω–æ–º Telegram.</p>';
} else {
  const tg   = Telegram.WebApp;          // –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Å–µ–≤–¥–æ–Ω–∏–º
  const btn  = document.getElementById('btn');
  const out  = document.getElementById('count');
  const msg  = document.getElementById('msg');

  /* ------- –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥—Å—á—ë—Ç–∞ —à–∞–≥–æ–≤ (–ø—Ä–æ—Å—Ç–∞—è –ø–∏–∫–æ–≤–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è) ------- */
  let steps = 0, g = 0, prev = 0;
  const Œ± = 0.975,            // —Ñ–∏–ª—å—Ç—Ä –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏
        THR = 1.15,           // –ø–æ—Ä–æ–≥ (G)
        MIN = 300;            // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —à–∞–≥–∞–º–∏, –º—Å

  /* –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–∞ */
  window.addEventListener('accelerometer_changed', e => {
    const {x,y,z} = e.detail;
    const mag = Math.hypot(x,y,z);       // –º–æ–¥—É–ª—å —É—Å–∫–æ—Ä–µ–Ω–∏—è
    g = Œ±*g + (1-Œ±)*mag;                 // high-pass (—É–±–∏—Ä–∞–µ–º g)
    const a = mag - g;
    const t = performance.now();

    if (a > THR && t - prev > MIN) {     // –Ω–∞—à–ª–∏ –ø–∏–∫
      steps++; prev = t;
      out.textContent = steps;
    }
  });

  /* —É—Å–ø–µ—à–Ω—ã–π —Å—Ç–∞—Ä—Ç –¥–∞—Ç—á–∏–∫–∞ */
  window.addEventListener('accelerometer_started', () => {
    btn.textContent = '–°—Ç–æ–ø';
    btn.disabled = false;
    msg.textContent = '–î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ä—É–∫–µ –∏–ª–∏ –≤ –∫–∞—Ä–º–∞–Ω–µ –∏ –∏–¥–∏—Ç–µ üòä';
  });

  /* –æ—à–∏–±–∫–∏ –¥–∞—Ç—á–∏–∫–∞ */
  window.addEventListener('accelerometer_failed', e => {
    const err = e.detail?.error ?? 'unknown';
    msg.textContent = '–û—à–∏–±–∫–∞: ' + err;
    btn.textContent = '–°—Ç–∞—Ä—Ç';
    btn.disabled = false;
  });

  /* –∫–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø */
  btn.onclick = () => {
    if (btn.textContent === '–°—Ç–æ–ø') {
      tg.stopAccelerometer();
      btn.textContent = '–°—Ç–∞—Ä—Ç';
      msg.textContent = '–ü–∞—É–∑–∞';
      return;
    }
    btn.disabled = true;
    btn.textContent = '–ó–∞–ø—Ä–æ—Å‚Ä¶';
    msg.textContent = '';
    tg.startAccelerometer({refresh_rate:25});
  };

  tg.ready();                 // —Å–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ UI –≥–æ—Ç–æ–≤
}
</script>
</html>
