<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = Telegram?.WebApp;
if (!tg) { document.body.textContent = 'Откройте через Telegram'; throw 0; }

const btn = document.getElementById('btn');
const out = document.getElementById('count');
const msg = document.getElementById('msg');

let steps=0, g=0, prev=0, α=.975, THR=1.15, MIN=300, waitTimer;

function start() {
  btn.disabled = true; btn.textContent = 'Запрос…'; msg.textContent='';
  tg.startAccelerometer({refresh_rate:25});

  /* если за 2 с не придёт ответ – покажем сообщение */
  waitTimer = setTimeout(()=>{
    msg.textContent = 'Нет ответа от датчика. Обнова Telegram? Разрешения?';
    btn.disabled=false; btn.textContent='Старт';
  }, 2000);
}

window.addEventListener('accelerometer_started', () => {
  clearTimeout(waitTimer);
  btn.disabled=false; btn.textContent='Стоп';
  msg.textContent='Двигаемся!';
});

window.addEventListener('accelerometer_failed', e => {
  clearTimeout(waitTimer);
  btn.disabled=false; btn.textContent='Старт';
  msg.textContent='Ошибка: '+(e.detail?.error||'неизвестно');
});

window.addEventListener('accelerometer_changed', e => {
  const {x,y,z}=e.detail, mag=Math.hypot(x,y,z);
  g=α*g+(1-α)*mag; const a=mag-g, t=performance.now();
  if (a>THR && t-prev>MIN) { steps++; prev=t; out.textContent=steps; }
});

btn.onclick = () => btn.textContent==='Стоп' ? (tg.stopAccelerometer(),btn.textContent='Старт',msg.textContent='Пауза') : start();
tg.ready();
</script>
